name: Rust CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Format, Build & Test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy
        
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.rust }}-cargo-
        
      - name: Check formatting (Unix)
        if: runner.os != 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          cp Cargo.toml Cargo.toml.fmt-backup
          sed -i.bak 's/"neo-gui",//g; s/, "neo-gui"//g; s/"neo-gui"//g' Cargo.toml || true
          rm -rf neo-gui || true
          
          # Check formatting
          cargo fmt --all -- --check
          
          # Restore workspace
          mv Cargo.toml.fmt-backup Cargo.toml
          git checkout -- neo-gui || true
        
      - name: Check formatting (Windows)
        if: runner.os == 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          Copy-Item Cargo.toml Cargo.toml.fmt-backup
          (Get-Content Cargo.toml) -replace '"neo-gui",', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace ', "neo-gui"', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace '"neo-gui"', '' | Set-Content Cargo.toml
          Remove-Item -Recurse -Force neo-gui -ErrorAction SilentlyContinue
          
          # Check formatting
          cargo fmt --all -- --check
          
          # Restore workspace
          Move-Item Cargo.toml.fmt-backup Cargo.toml -Force
          git checkout -- neo-gui
        
      - name: Run clippy (Unix)
        if: runner.os != 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          cp Cargo.toml Cargo.toml.clippy-backup
          sed -i.bak 's/"neo-gui",//g; s/, "neo-gui"//g; s/"neo-gui"//g' Cargo.toml || true
          rm -rf neo-gui || true
          
          # Run clippy
          cargo clippy --workspace --all-targets --all-features -- -D warnings
          
          # Restore workspace
          mv Cargo.toml.clippy-backup Cargo.toml
          git checkout -- neo-gui || true
        
      - name: Run clippy (Windows)
        if: runner.os == 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          Copy-Item Cargo.toml Cargo.toml.clippy-backup
          (Get-Content Cargo.toml) -replace '"neo-gui",', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace ', "neo-gui"', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace '"neo-gui"', '' | Set-Content Cargo.toml
          Remove-Item -Recurse -Force neo-gui -ErrorAction SilentlyContinue
          
          # Run clippy
          cargo clippy --workspace --all-targets --all-features -- -D warnings
          
          # Restore workspace
          Move-Item Cargo.toml.clippy-backup Cargo.toml -Force
          git checkout -- neo-gui
        
      - name: Build (no default features) (Unix)
        if: runner.os != 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          cp Cargo.toml Cargo.toml.build1-backup
          sed -i.bak 's/"neo-gui",//g; s/, "neo-gui"//g; s/"neo-gui"//g' Cargo.toml || true
          rm -rf neo-gui || true
          
          # Build with no default features
          cargo build --verbose --no-default-features
          
          # Restore workspace
          mv Cargo.toml.build1-backup Cargo.toml
          git checkout -- neo-gui || true
        
      - name: Build (no default features) (Windows)
        if: runner.os == 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          Copy-Item Cargo.toml Cargo.toml.build1-backup
          (Get-Content Cargo.toml) -replace '"neo-gui",', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace ', "neo-gui"', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace '"neo-gui"', '' | Set-Content Cargo.toml
          Remove-Item -Recurse -Force neo-gui -ErrorAction SilentlyContinue
          
          # Build with no default features
          cargo build --verbose --no-default-features
          
          # Restore workspace
          Move-Item Cargo.toml.build1-backup Cargo.toml -Force
          git checkout -- neo-gui
        
      - name: Build (all features) (Unix)
        if: runner.os != 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          cp Cargo.toml Cargo.toml.build2-backup
          sed -i.bak 's/"neo-gui",//g; s/, "neo-gui"//g; s/"neo-gui"//g' Cargo.toml || true
          rm -rf neo-gui || true
          
          # Build with all features
          cargo build --verbose --all-features
          
          # Restore workspace
          mv Cargo.toml.build2-backup Cargo.toml
          git checkout -- neo-gui || true
        
      - name: Build (all features) (Windows)
        if: runner.os == 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          Copy-Item Cargo.toml Cargo.toml.build2-backup
          (Get-Content Cargo.toml) -replace '"neo-gui",', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace ', "neo-gui"', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace '"neo-gui"', '' | Set-Content Cargo.toml
          Remove-Item -Recurse -Force neo-gui -ErrorAction SilentlyContinue
          
          # Build with all features
          cargo build --verbose --all-features
          
          # Restore workspace
          Move-Item Cargo.toml.build2-backup Cargo.toml -Force
          git checkout -- neo-gui
        
      - name: Run core library tests (Unix)
        if: runner.os != 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          cp Cargo.toml Cargo.toml.test-backup
          sed -i.bak 's/"neo-gui",//g; s/, "neo-gui"//g; s/"neo-gui"//g' Cargo.toml || true
          rm -rf neo-gui || true
          
          # Run tests
          NEORUST_SKIP_NETWORK_TESTS=1 cargo test --workspace --lib --all-features --quiet
          
          # Restore workspace
          mv Cargo.toml.test-backup Cargo.toml
          git checkout -- neo-gui || true
        
      - name: Run core library tests (Windows)
        if: runner.os == 'Windows'
        run: |
          # Create a clean workspace without neo-gui to prevent dependency issues
          Copy-Item Cargo.toml Cargo.toml.test-backup
          (Get-Content Cargo.toml) -replace '"neo-gui",', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace ', "neo-gui"', '' | Set-Content Cargo.toml
          (Get-Content Cargo.toml) -replace '"neo-gui"', '' | Set-Content Cargo.toml
          Remove-Item -Recurse -Force neo-gui -ErrorAction SilentlyContinue
          
          # Run tests
          $env:NEORUST_SKIP_NETWORK_TESTS = "1"
          cargo test --workspace --lib --all-features --quiet
          
          # Restore workspace
          Move-Item Cargo.toml.test-backup Cargo.toml -Force
          git checkout -- neo-gui
